// Этот файл экспортирует ОДНУ функцию, которая принимает 'role' в качестве аргумента
// и ВОЗВРАЩАЕТ другую функцию (middleware).
// Это называется "функция высшего порядка".

module.exports = function(role) {
    
    // Вот эта функция возвращается и используется Express'ом
    return function (req, res, next) {
        if (req.method === "OPTIONS") {
            next();
        }
        
        try {
            // Проверяем, что authMiddleware уже отработал
            // и добавил информацию о пользователе в req.user
            if (!req.user) {
                return res.status(401).json({ message: "Пользователь не авторизован" });
            }
            
            // Сравниваем роль пользователя с необходимой ролью
            if (req.user.role !== role) {
                return res.status(403).json({ message: "Нет доступа" });
            }
            
            // Если все проверки пройдены, передаем управление дальше
            next();

        } catch (e) {
            // Общая ошибка на случай непредвиденных проблем
            res.status(401).json({ message: "Пользователь не авторизован" });
        }
    };
    
}